<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyProfileApp</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body data-logged="{{ '1' if session.get('user_id') else '0' }}">
  <header class="site-header">
    <div class="nav-left">
      <a href="{{ url_for('index') }}" class="brand">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="logo" class="brand-logo">
        <span class="brand-name">MyProfileApp</span>
      </a>
    </div>
    <nav class="nav-right">
      {% if nav.show_login %}
        <a href="{{ url_for('login') }}" class="btn link">Login</a>
      {% endif %}
      {% if nav.show_register %}
        <a href="{{ url_for('register') }}" class="btn primary">Register</a>
      {% endif %}
      {% if nav.show_logout %}
        <button type="button" class="btn danger" id="logoutBtn">Logout</button>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, msg in messages %}
            <li class="flash {{ category }}">{{ msg | safe }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <footer>
    <p>&copy; 2025 MyProfileApp</p>
  </footer>

  <!-- Modal for logout warning on back/forward -->
  <div id="logoutWarningModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Session Security</h3>
      <p>You are trying to navigate away. If you go back, your session will be logged out for security.</p>
      <div class="modal-actions">
        <button class="btn primary" type="button" onclick="confirmLogout()">Logout & Go Back</button>
        <button class="btn link" type="button" onclick="closeModal()">Stay Here</button>
      </div>
    </div>
  </div>

  <style>
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      text-align: center;
    }
    .modal-content h3 {
      margin: 0 0 1rem 0;
      color: #2b6cb0;
    }
    .modal-content p {
      margin: 0 0 1.5rem 0;
      color: #6b7280;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
  </style>

  <script>
    const isLoggedIn = document.body.dataset.logged === '1';
    let allowBackNavigation = false;
    let logoutInProgress = false;

    // Logout handler
    function submitLogout(){
      if (logoutInProgress) return;
      logoutInProgress = true;
      allowBackNavigation = true;

      fetch("{{ url_for('logout') }}", { 
        method: "POST", 
        credentials: "same-origin",
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
        .then(r => r.json())
        .then(j => { 
          window.location.replace(j.redirect || "{{ url_for('index') }}"); 
        })
        .catch(()=> {
          window.location.replace("{{ url_for('index') }}");
        });
    }

    // Modal functions
    function showLogoutWarning() {
      const modal = document.getElementById('logoutWarningModal');
      if (modal) modal.style.display = 'flex';
    }

    function closeModal() {
      const modal = document.getElementById('logoutWarningModal');
      if (modal) modal.style.display = 'none';
    }

    function confirmLogout() {
      allowBackNavigation = true;
      closeModal();
      
      fetch("{{ url_for('logout') }}", { 
        method: "POST", 
        credentials: "same-origin",
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
        .then(r => r.json())
        .then(j => {
          window.location.replace(j.redirect || "{{ url_for('index') }}");
        })
        .catch(() => {
          window.location.replace("{{ url_for('index') }}");
        });
    }

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', function() {
      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', submitLogout);
      }

      // Password toggle
      document.addEventListener('click', function(e){
        if(e.target?.classList?.contains('toggle-password')){
          const input = e.target.closest('label')?.querySelector('.password-input');
          if(input){
            input.type = input.type === 'password' ? 'text' : 'password';
            e.target.textContent = input.type === 'text' ? 'ðŸ™ˆ' : 'ðŸ‘ï¸';
          }
        }
      });

      // AJAX forms
      document.querySelectorAll('form[data-ajax="true"]').forEach(form => {
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          const formData = new FormData(this);
          
          try {
            const res = await fetch(this.action || location.pathname, {
              method: 'POST',
              body: formData,
              credentials: 'same-origin',
              headers: {'X-Requested-With': 'XMLHttpRequest'}
            });

            const contentType = res.headers.get('content-type');
            if(contentType?.includes('application/json')){
              const data = await res.json();
              if(data.ok && data.redirect){
                window.location.replace(data.redirect);
              } else {
                alert(data.error || 'Error occurred');
              }
            } else {
              window.location.reload();
            }
          } catch(err) {
            console.error('Form error:', err);
            alert('An error occurred');
          }
        });
      });

      // Initialize history
      if (isLoggedIn) {
        history.pushState({protected: true}, '', location.href);
      }
    });

    // Back button prevention for logged-in users
    window.addEventListener('popstate', function(e) {
      if (isLoggedIn && !allowBackNavigation) {
        showLogoutWarning();
        history.pushState({protected: true}, '', location.href);
      }
    });
  </script>
</body>
</html>